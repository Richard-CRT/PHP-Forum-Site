<?phpinclude("../config.php");include($config["WRoot"].$config["FRoot"]."/headers/utf8Headers.php");include($config["WRoot"].$config["FRoot"]."/scripts/sessionHandler.php");include($config["WRoot"].$config["FRoot"]."/headers/HTMLvariables.php");// Case insensitive function to count substring occurancefunction substri_count($haystack, $needle) {	return substr_count(mb_strtoupper($haystack, 'UTF-8'), mb_strtoupper($needle, 'UTF-8'));}$errors = array(1 => "Username Changed!",				2 => "Unexpected Error :(",				3 => "Not Logged In.",				4 => "Account deleted!",				6 => "User does not exist.",				9 => "Password reset link has expired.");?><?php echo $doctype; ?><html>	<head>		<title>Forum</title>		<meta http-equiv='Content-Type' content='text/html; charset=utf-8'>	</head>	<body><?php			// Connect to DB			if(!isset($pdo)) {				try {					$pdo = new PDO('mysql:host='.$config['DBhost'].';dbname='.$config['DBname'], $config['DBusername'], $config['DBpassword'], $config['DBoptions']);				} catch (PDOException $e) {					echo 'Connection failed: ' . $e->getMessage();					die;				}			}						// Define a refer link for our 'header' so login/logout refer us back to correct page			$headerRefer = $config['FRoot'];			// Include the header in our pages			include($config["WRoot"].$config["FRoot"]."/classes/header.php");			if (isset($_GET['code']) and is_numeric($_GET['code']) and isset($errors[intval($_GET['code'])])) {				echo "\t\t".$errors[intval($_GET['code'])]."<br />\n";			}						if (isset($_GET['forum']) and is_numeric($_GET['forum']) and $_GET['forum'] >= -1) {				$_GET['post'] = null;			}			else if (isset($_GET['post']) and is_numeric($_GET['post']) and $_GET['post'] >= -1) {				$_GET['forum'] = null;			}			else {				$_GET['forum'] = -1;				$_GET['post'] = null;			}						if ($_GET['post'] == null) {								$forumId = $_GET['forum'];				$stmt = $pdo->prepare('SELECT Parent FROM Forums WHERE ForumId = :forumId;');				$stmt->bindParam(':forumId', $forumId, PDO::PARAM_INT); // <-- Automatically sanitized for SQL by PDO				$stmt->execute();				$row = $stmt->fetch();				$parentForumId = $row['Parent'];								$stmt = $pdo->prepare('SELECT ForumId,Title,Topic,Locked FROM Forums WHERE Parent = :parentId;');				$stmt->bindParam(':parentId', $_GET['forum'], PDO::PARAM_INT); // <-- Automatically sanitized for SQL by PDO				$stmt->execute();				$rows = $stmt->fetchAll();				if ($forumId != -1)				{					echo "<a href='?forum=".$parentForumId."'>Parent</a><br />\n";				}				echo "Forums:<br />\n";				echo "<table>\n";				echo "<th>Forum Title</th><th>Forum Topic</th><th>Locked</th>\n";				foreach ($rows as $row)				{					echo "<tr>\n";					echo "<td><a href='?forum=".$row['ForumId']."'>".$row['Title']."</a></td><td>".$row['Topic']."</td><td>".$row['Locked']."</td>\n";					echo "</tr>\n";				}				echo "</table>\n";								$stmt = $pdo->prepare('SELECT PostId,UserId,Title FROM Posts WHERE ForumId = :parentId;');				$stmt->bindParam(':parentId', $_GET['forum'], PDO::PARAM_INT); // <-- Automatically sanitized for SQL by PDO				$stmt->execute();				$rows = $stmt->fetchAll();				echo "Posts:<br />\n";				echo "<table>\n";				echo "<th>Post Title</th><th>Poster</th>\n";				foreach ($rows as $row)				{					$userId = $row['UserId'];					$stmt2 = $pdo->prepare('SELECT Username FROM Users WHERE Id = :userId;');					$stmt2->bindParam(':userId', $userId, PDO::PARAM_INT); // <-- Automatically sanitized for SQL by PDO					$stmt2->execute();					$row2 = $stmt2->fetch();										echo "<tr>\n";					echo "<td><a href='?post=".$row['PostId']."'>".$row['Title']."</a></td><td>".$row2['Username']."</td>\n";					echo "</tr>\n";				}				echo "</table>\n";			}			else if ($_GET['forum'] == null)			{				$postId = $_GET['post'];								$stmt = $pdo->prepare('SELECT ForumId FROM Posts WHERE PostId = :postId;');				$stmt->bindParam(':postId', $postId, PDO::PARAM_INT); // <-- Automatically sanitized for SQL by PDO				$stmt->execute();				$row = $stmt->fetch();				$forumId = $row['ForumId'];								$stmt = $pdo->prepare('SELECT UserId,Posted,Edited,Content FROM Replies WHERE PostId = :postId ORDER BY Posted ASC;');				$stmt->bindParam(':postId', $postId, PDO::PARAM_INT); // <-- Automatically sanitized for SQL by PDO				$stmt->execute();				$rows = $stmt->fetchAll();				echo "<a href='?forum=".$forumId."'>Parent</a><br />\n";				echo "<table>\n";				echo "<th>Poster</th><th>Posted</th><th>Edited</th><th>Content</th>\n";				foreach ($rows as $row)				{					$userId = $row['UserId'];					$stmt2 = $pdo->prepare('SELECT Username FROM Users WHERE Id = :userId;');					$stmt2->bindParam(':userId', $userId, PDO::PARAM_INT); // <-- Automatically sanitized for SQL by PDO					$stmt2->execute();					$row2 = $stmt2->fetch();					$postedTime = date('H:i:s d-m-Y', $row['Posted']);					$editedTime = date('H:i:s d-m-Y', $row['Edited']);					echo "<tr>\n";					echo "<td>".$row2['Username']."</td><td>".$postedTime."</td><td>".$editedTime."</td><td>".$row['Content']."</td>\n";					echo "</tr>\n";				}				echo "</table>\n";			}?>	</body></html>